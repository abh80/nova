image:
  file: dockerFile
  context: .

tasks:
  - name: Start Postgres
    command: |
      echo "Starting Postgres"
      service postgresql start

  - name: Set Enviroment Variables
    command: |
      echo "Setting Enviroment Variables"
      echo "export GRADLE_USER_HOME=`pwd`/.gradle" >> ~/.bashrc
      echo "export TF_VAR_postgres_username=postgres" >> ~/.bashrc
      echo "export TF_VAR_postgres_db_password=postgres" >> ~/.bashrc
      echo "TF_VAR_postgres_host=localhost" >> ~/.bashrc

  - name: Run vault server
    command: |
      echo "Running vault server"
      vault server -dev -dev-root-token-id="root"
      echo "export VAULT_ADDR=http://localhost:8200" >> ~/.bashrc
      echo "export VAULT_TOKEN=root" >> ~/.bashrc
      echo "export TF_VAR_vault_token=root" >> ~/.bashrc
      source ~/.bashrc

  - name: Run Terraform
    command: |
      echo "Running Terraform"
      terraform -chdir=terraform/dev/postgres-provisioner init
      terraform -chdir=terraform/dev/postgres-provisioner apply -auto-approve

      terraform -chdir=terraform/dev/vault-provisioner init
      terraform -chdir=terraform/dev/vault-provisioner apply -auto-approve

      echo "Terraform apply completed"
