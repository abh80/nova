#!/bin/bash

echo "ğŸš€ Starting pre hooks..."
echo "----------------------"

BRANCH=$(git rev-parse --abbrev-ref HEAD)
PROTECTED_BRANCHES="^(master|main)"

if [[ "$BRANCH" =~ $PROTECTED_BRANCHES ]]; then
  echo -e "\nâŒ Cannot push to remote $BRANCH branch. Please create your own branch and use a pull request.\n"
  exit 1
fi

echo "âœ… Finish checking branch name. $BRANCH is allowed to push on."


printf "\n------------------------\n"
echo "ğŸ› ï¸ Running Scala tests..."
echo "------------------------"

printf "ğŸ‘€ Cleaning any existing Gradle Builds ğŸ˜ ..."
scalaclean_output=$(./gradlew clean)
scalaclean_exit_code=$?

if [ $scalaclean_exit_code -ne 0 ]; then
  echo "$scalaclean_output"
  echo "âŒ Gradle clean failed, please fix these issues before commiting"
  exit 1
else printf "\b\b\b âœ…\n"
fi
echo

printf "âŒš Now running your precious test cases..."
scalatest_output=$(./gradlew test)
scalatest_exit_code=$?

if [ $scalatest_exit_code -ne 0 ]; then
  echo "$scalatest_output"
  echo "âŒ Scala tests failed, please fix these issues before commiting"
  exit 1
else
  printf "\b\b\b âœ…\n"
  echo
  echo "ğŸ˜ All tests passed!"
fi
echo
echo "ğŸ‰ Pre push hook completed."
echo
exit 0